---
title: "02_mwas"
author: "Jagadeesh Puvvula"
date: "2025-01-01"
output: pdf_document
---

#load exposure and covariates data
```{r}
load("~/Documents/air_polln_metabolomics/analytic_dat/exp_cov_df.rda")
```

#read metabolomics data
```{r}
#batch normalized and imputed for any missing metabolite intensity - as received from Metabolon
placenta_metabolome<- read_csv(paste0(data, "metabolome_batch_norm_imputed.csv")) |>
  mutate(across(2:last_col(), ~ log10(. + 0.00001))) |>
  mutate(across(2:last_col(), ~ (. - mean(.)) / sd(.)))

#annotation dictionary
df_annotations<- read_csv(paste0(data, "metabolome_annota.csv")) |>
  clean_names()

#summarizing metabolite annotations
df_summary <- df_annotations |>
  group_by(super_pathway) |>
  summarise(metabolites_count = n(),
            UNIQUE_SUB_PATHWAYS_count = n_distinct(sub_pathway),
            SUB_PATHWAYS_list = paste(sub_pathway, collapse = ", "))
```

#remove un-named metabolites for the analysis
```{r}
filtered_chem_ids <- c("PARENT_SAMPLE_NAME", df_annotations |>
                         filter(type == "NAMED") |>
                         pull(chem_id))
  
df_placenta_metabolome <- placenta_metabolome |>
  dplyr::select(any_of(as.character(filtered_chem_ids))) |>
  clean_names()
```

#drop metabolites that have identical values 
```{r}
df_placenta_metabolome_filt <- df_placenta_metabolome |>
  dplyr::select(-where(~any(is.na(.))))
```


#drop 7 participants from metabolome data with missing address and dates
```{r}
filtered_placenta_metabolome <- df_placenta_metabolome_filt |>
  filter(parent_sample_name %in% exp_cov_df$parent_sample_name)

#transpose metabolite set
transposed_df <- filtered_placenta_metabolome |>
  t() |>
  as_tibble(rownames = "Variable") |>
  row_to_names(row_number = 1) |>
  rename(chem_id = 1) |>
  mutate(chem_id = sub("^x", "", chem_id))
```

#save df_update and filtered placenta_metabolome files for next steps
```{r}
save(exp_cov_df, transposed_df, df_annotations,
     file = "~/Documents/air_polln_metabolomics/analytic_dat/df_metabolome_analysis.rda")
```

#MWAS
```{r}
load("~/Documents/air_polln_metabolomics/analytic_dat/df_metabolome_analysis.rda")
exp_cov_df<- exp_cov_df |>
  rename(participant_id = parent_sample_name)
```

#monthly air pollution anomalies
```{r}
# Define thresholds
pm_thresh <- 9
bc_thresh <- 1
days_per_month <- 30

# Automatically detect number of pm_* and bc_* columns
n_pm <- exp_cov_df |> select(starts_with("pm_")) |> ncol()
n_bc <- exp_cov_df |> select(starts_with("bc_")) |> ncol()

months_pm <- ceiling(n_pm / days_per_month)
months_bc <- ceiling(n_bc / days_per_month)

# Compute monthly and trimester counts
exp_cov_df <- exp_cov_df |>
  mutate(
    # Overall counts
    pm_cnt = rowSums(across(starts_with("pm_")) > pm_thresh, na.rm = TRUE),
    bc_cnt = rowSums(across(starts_with("bc_")) > bc_thresh, na.rm = TRUE)
  )

# ---- Add Monthly PM Counts ----
for (m in seq_len(months_pm)) {
  start <- (m - 1) * days_per_month + 1
  end <- min(m * days_per_month, n_pm)
  cols <- paste0("pm_", start:end)
  exp_cov_df[[paste0("pm_", m, "month")]] <-
    rowSums(exp_cov_df[, intersect(cols, names(exp_cov_df))] > pm_thresh, na.rm = TRUE)
}

# ---- Add Monthly BC Counts ----
for (m in seq_len(months_bc)) {
  start <- (m - 1) * days_per_month + 1
  end <- min(m * days_per_month, n_bc)
  cols <- paste0("bc_", start:end)
  exp_cov_df[[paste0("bc_", m, "month")]] <-
    rowSums(exp_cov_df[, intersect(cols, names(exp_cov_df))] > bc_thresh, na.rm = TRUE)
}

# ---- Add Trimester PM Counts (3 months each) ----
for (t in seq_len(ceiling(months_pm / 3))) {
  start_month <- (t - 1) * 3 + 1
  end_month <- min(t * 3, months_pm)
  month_cols <- paste0("pm_", start_month:end_month, "month")
  exp_cov_df[[paste0("pm_trimester_", t)]] <-
    rowSums(exp_cov_df[, intersect(month_cols, names(exp_cov_df))], na.rm = TRUE)
}

# ---- Add Trimester BC Counts (3 months each) ----
for (t in seq_len(ceiling(months_bc / 3))) {
  start_month <- (t - 1) * 3 + 1
  end_month <- min(t * 3, months_bc)
  month_cols <- paste0("bc_", start_month:end_month, "month")
  exp_cov_df[[paste0("bc_trimester_", t)]] <-
    rowSums(exp_cov_df[, intersect(month_cols, names(exp_cov_df))], na.rm = TRUE)
}

cols_to_drop <- 23:556
exp_cov_df <- exp_cov_df[, -cols_to_drop, drop = FALSE]
```

#exposure trends 
```{r}
exp_viz_summary <- exp_cov_df %>%
  select(c(1, 25:42)) %>%
  pivot_longer(
    cols = -participant_id,
    names_to = "variable",
    values_to = "anomaly_days"
  ) %>%
  mutate(
    exposure = case_when(
      str_starts(variable, "bc") ~ "Black carbon",
      str_starts(variable, "pm") ~ "PM2.5",
      TRUE ~ NA_character_
    ),
    exposure_window = case_when(
      str_ends(variable, "1month") ~ "1 month",
      str_ends(variable, "2month") ~ "2 month",
      str_ends(variable, "3month") ~ "3 month",
      str_ends(variable, "4month") ~ "4 month",
      str_ends(variable, "5month") ~ "5 month",
      str_ends(variable, "6month") ~ "6 month",
      str_ends(variable, "7month") ~ "7 month",
      str_ends(variable, "8month") ~ "8 month",
      str_ends(variable, "9month") ~ "9 month",
      TRUE ~ NA_character_
    ),
    exposure_window = factor(
      exposure_window,
      levels = c("1 month", "2 month", "3 month",
                 "4 month", "5 month", "6 month",
                 "7 month", "8 month", "9 month")
    )
  ) %>%
  group_by(exposure_window, exposure) %>%
  summarise(
    q25 = quantile(anomaly_days, 0.25, na.rm = TRUE),
    median = median(anomaly_days, na.rm = TRUE),
    q75 = quantile(anomaly_days, 0.75, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(stat = paste0(median, " (", q25, ", ", q75, ")")) %>%
  select(exposure_window, exposure, stat) %>%
  pivot_wider(
    names_from = exposure,
    values_from = stat
  )

write_csv(exp_viz_summary, "~/Documents/air_polln_metabolomics/result/lm_mwas/exposure_summary_tbl.csv")
```

#scatter plot pm2.5 and bw z-score (use data from file 05_mediation)
```{r}
load("~/Documents/air_polln_metabolomics/analytic_dat/for_mediation.rda")

library(tidyverse)

# Step 1: Create sctr_viz with proper pivoting
sctr_viz <- med_df %>%
  select(
    # Fixed variables (ID and outcome)
    id, sex, bw_z_scr,
    # Confounders
    race_ethnicity, education, bmi, parity, ga_at_delivery, 
    tobacco_use_dur_preg, alcoh_use_dur_preg,
    # Exposure variables to pivot
    pm_1month, pm_2month, pm_3month, pm_4month, pm_5month, 
    pm_6month, pm_7month, pm_8month, pm_9month,
    bc_1month, bc_2month, bc_3month, bc_4month, bc_5month, 
    bc_6month, bc_7month, bc_8month, bc_9month
  ) %>%
  pivot_longer(
    cols = starts_with("pm") | starts_with("bc"),
    names_to = "variable",
    values_to = "anomaly_days"
  ) %>%
  mutate(
    exposure = case_when(
      str_starts(variable, "bc") ~ "Black carbon",
      str_starts(variable, "pm") ~ "PM2.5",
      TRUE ~ NA_character_
    ),
    exposure_window = case_when(
      str_ends(variable, "1month") ~ "1 month",
      str_ends(variable, "2month") ~ "2 month",
      str_ends(variable, "3month") ~ "3 month",
      str_ends(variable, "4month") ~ "4 month",
      str_ends(variable, "5month") ~ "5 month",
      str_ends(variable, "6month") ~ "6 month",
      str_ends(variable, "7month") ~ "7 month",
      str_ends(variable, "8month") ~ "8 month",
      str_ends(variable, "9month") ~ "9 month",
      TRUE ~ NA_character_
    ),
    exposure_window = factor(
      exposure_window,
      levels = c("1 month", "2 month", "3 month",
                 "4 month", "5 month", "6 month",
                 "7 month", "8 month", "9 month")
    )
  )

# Step 2: Create partial regression plots
# Adjust BOTH outcome and exposure for confounders separately
adjusted_data <- sctr_viz %>%
  nest(data = -c(exposure, exposure_window, sex)) %>%
  mutate(
    # Model 1: outcome adjusted for all confounders
    outcome_model = map(data, ~lm(bw_z_scr ~ race_ethnicity + education + bmi + parity + 
                                    ga_at_delivery + tobacco_use_dur_preg + alcoh_use_dur_preg, 
                                   data = .x)),
    # Model 2: exposure adjusted for all confounders
    exposure_model = map(data, ~lm(anomaly_days ~ race_ethnicity + education + bmi + parity + 
                                    ga_at_delivery + tobacco_use_dur_preg + alcoh_use_dur_preg, 
                                    data = .x)),
    # Extract residuals from both models
    residuals = pmap(list(data, outcome_model, exposure_model), 
                     ~..1 %>% 
                       mutate(
                         outcome_resid = residuals(..2),
                         exposure_resid = residuals(..3)
                       ))
  ) %>%
  unnest(residuals) %>%
  select(-outcome_model, -exposure_model, -data)

# Step 3: Create the scatter plot with partial regression trend lines
ggplot(adjusted_data, aes(x = exposure_resid, y = outcome_resid, color = sex)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "lm", se = FALSE, inherit.aes = TRUE) +
  facet_grid(exposure ~ exposure_window, scales = "free") +
  theme_minimal() +
  scale_color_manual(values = c("Male" = "darkblue", "Female" = "darkred")) +
  labs(
    x = "Days with high air pollutant exposure",
    y = "Birth weight Z-Score",
    color = "Sex"
  ) +
  theme(legend.position = "bottom",
        axis.title.x = element_text(size = 9),
        axis.title.y = element_text(size = 9))

ggsave("~/Documents/air_polln_metabolomics/result/lm_mwas/pm2.5_bw_zscore_scatter.tiff",
       dpi=300,
       bg="white",
       width = 10,
       height = 5)
```


#MWAS - loop
```{r}
# Full population
mwas_lm_loop(
  feature_table = transposed_df, 
  exp_cov_data = exp_cov_df,
  exposures = names(exp_cov_df)[25:42],
  covar = c("race_ethnicity", "education", "bmi", "parity",
            "ga_at_delivery", "tobacco_use_dur_preg", 
            "alcoh_use_dur_preg", "gender"), 
  output_folder = "~/Documents/air_polln_metabolomics/result/lm_mwas",
  mwas_file_name = "placenta_mwas_oct_2025.csv",
  fdr_cutoff = 0.2,
  sex_var = "gender", analyze_by_sex = TRUE,
  participant_id_col = "participant_id"
  )
```

#add metabolite annotations to mwas results
```{r}
res_df<- read_csv("~/Documents/air_polln_metabolomics/result/lm_mwas/placenta_mwas_oct_2025.csv") |>
  left_join(df_annotations |> select(c(1,11,5,6,16:19)), by= "chem_id")

write_csv(res_df, "~/Documents/air_polln_metabolomics/result/lm_mwas/placenta_mwas_oct_2025_anno.csv")
```

#summary of results
```{r}
res_df<- read_csv("~/Documents/air_polln_metabolomics/result/lm_mwas/placenta_mwas_oct_2025_anno.csv") |>
  select(-c(9)) |>
  mutate(sub_pathway = str_remove(sub_pathway, " Metabolism$")) |>
  clean_names() |>
  filter(fdr<0.2) |>
  mutate(across(where(is.character), as.factor))|>
  mutate(
    exposure = case_when(
      str_starts(variable, "bc") ~ "Black carbon",
      str_starts(variable, "pm") ~ "PM2.5",
      TRUE ~ NA_character_
    ),
    exposure_window = case_when(
      str_ends(variable, "1month") ~ "1 month",
      str_ends(variable, "2month") ~ "2 month",
      str_ends(variable, "3month") ~ "3 month",
      str_ends(variable, "4month") ~ "4 month",
      str_ends(variable, "5month") ~ "5 month",
      str_ends(variable, "6month") ~ "6 month",
      str_ends(variable, "7month") ~ "7 month",
      str_ends(variable, "8month") ~ "8 month",
      str_ends(variable, "9month") ~ "9 month",
      TRUE ~ NA_character_
      ),
    exposure_window = factor(
      exposure_window,
      levels = c("1 month", "2 month", "3 month",
                 "4 month", "5 month", "6 month",
                 "7 month", "8 month", "9 month")
      ),
  super_pathway = recode(super_pathway, 
                           "Partially Characterized Molecules" = "Other",
                           "Energy" = "Other"),
  super_pathway = fct_relevel(super_pathway, 
                               "Lipid", 
                               "Amino Acid", 
                               "Carbohydrate", 
                               "Cofactors and Vitamins", 
                               "Peptide", 
                               "Nucleotide", 
                               "Xenobiotics",
                               "Other"),
  sex = factor(sex, levels = c("overall", "Male", "Female"))
  ) 

#summary of MWAS results
summary_df <- res_df |>
  group_by(exposure, sex, super_pathway, sub_pathway) |>
  summarise(
    distinct_exposure_windows = n_distinct(exposure_window),
    exposure_windows = paste(unique(exposure_window), collapse = ", ") |> str_replace_all("\\s+month", ""),
    metabolite_count = n(),
    metabolites = paste(unique(chemical_name), collapse = ", "),
    .groups = "drop"
  ) |>
  filter(exposure_windows > 1,
         metabolite_count > 2)
```

#visualizing results - Summarized heat map
```{r}
ggplot(summary_df, aes(x = exposure_window, y = sub_pathway, fill = count)) +
  facet_nested(super_pathway ~ exposure + sex,
               scales = "free",
               space = "free",
               switch = "both",
               labeller = label_wrap_gen(width = 15)) +
  geom_tile(color = "white") + 
  scale_fill_viridis(
  name = "Number of metabolites",
  breaks = c(1, 5, 10, 15),
  labels = c("1", "5", "10", "15"),
  limits = c(1, 15)
  ) +
  labs(x = "Gestational period - Third trimester", y = "Metabolic pathways") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 0.5, color="black"),
        axis.text.y = element_text(size=10, color="black"),
        legend.position = "bottom",
        legend.text = element_text(angle = 0, hjust = 1, color="black"),
        legend.title = element_text(vjust = 1),
        legend.key.height = unit(0.3, "cm"),
        panel.grid.major.x = element_blank(), 
        panel.grid.minor.x = element_blank(),
        strip.text.y = element_text(size=9, angle = 45, hjust = 0, color="black", face="bold"),
        strip.text.x = element_text(size=11, color="black"),
        strip.placement = "outside", 
        strip.background = element_blank() )
```

```{r}
ggsave("~/Documents/air_polln_metabolomics/result/lm_mwas/mwas_pathway.tiff",
       dpi=300,
       bg="white",
       width = 12,
       height = 14)
```

# consolidated shapley style plot
```{r}
# Create your plot function (same as before)
create_pathway_plot <- function(data, pathway) {
  subset_data <- data %>% 
    filter(super_pathway == pathway) |>
    filter(str_starts(variable, "pm"))
  
  ggplot(subset_data, aes(x = estimate, y = sub_pathway)) +
    # Non-significant points first (gray, transparent)
    geom_point(
      data = subset_data[subset_data$fdr >= 0.2, ],
      color = "lightgray", alpha = 0.3, size = 0.5,
      position = position_jitter(height = 0.2, width = 0.01)
    ) +
    # Significant positive points (red)
    geom_point(
      data = subset_data[subset_data$fdr < 0.2 & subset_data$estimate > 0, ],
      color = "royalblue", alpha = 1, size = 0.5,
      position = position_jitter(height = 0.2, width = 0.01)
    ) +
    # Significant negative points (blue) 
    geom_point(
      data = subset_data[subset_data$fdr < 0.2 & subset_data$estimate < 0, ],
      color = "red", alpha = 1, size = 0.5,
      position = position_jitter(height = 0.2, width = 0.01)
    ) +
    geom_vline(xintercept = 0, color = "black", linetype = "dotted") +
    labs(x = NULL, y = NULL, title = pathway) +
    theme_minimal() +
    theme(
      plot.title = element_text(size = 8.3, color = "black", face = "bold"),
      axis.text.x = element_text(size = 8, colour = "black"),
      axis.text.y = element_text(size = 8, colour = "black"),
      panel.spacing = unit(1, "lines")
    )
}

# Create your plots
# First check if any devices are open and close them
while(dev.cur() > 1) dev.off()

# Open the TIFF device
tiff(
  filename = "~/Documents/air_polln_metabolomics/result/lm_mwas/mwas_lm_summmary_pm.tiff",
  width = 14,
  height = 12,
  units = "in",
  res = 300
)

# Create your plots
lipid_plot <- create_pathway_plot(res_df, "Lipid")
col2_plots <- list(
  create_pathway_plot(res_df, "Amino Acid"),
  create_pathway_plot(res_df, "Carbohydrate"),
  create_pathway_plot(res_df, "Nucleotide")
)
col3_plots <- list(
  create_pathway_plot(res_df, "Cofactors and Vitamins"),
  create_pathway_plot(res_df, "Energy"),
  create_pathway_plot(res_df, "Partially Characterized Molecules"),
  create_pathway_plot(res_df, "Peptide"),
  create_pathway_plot(res_df, "Xenobiotics")
)

# Create column arrangements
col2 <- arrangeGrob(grobs = col2_plots, ncol = 1)
col3 <- arrangeGrob(grobs = col3_plots, ncol = 1)

# Combine all three columns into final layout
g <- arrangeGrob(lipid_plot, col2, col3, ncol = 3)

# Draw the plot
grid.draw(g)

# Close the device
dev.off()
```

#Metabolie level plot
#load mwas results
```{r}
res_df<- read_csv("~/Documents/air_polln_metabolomics/result/lm_mwas/placenta_mwas_oct_2025_anno.csv") |>
  clean_names()

# Set filter options
filter_type <- "any"  # Change to "any" for any N windows
n_windows <- 4  # Change to desired number of windows

summary_df2 <- res_df |>
  filter(fdr < 0.2,
         !str_detect(variable, "cnt$")) |>
  mutate(
    chemical_name = str_to_title(chemical_name),
    prefix = str_remove(variable, "_?\\d+month$"),
    month_num = as.integer(str_extract(variable, "(?<=_)\\d+(?=month$)"))
  ) |>
  filter(!is.na(prefix), !is.na(month_num)) |>
  arrange(chemical_name, super_pathway, sub_pathway, prefix, sex, month_num) |>
  group_by(chemical_name, super_pathway, sub_pathway, prefix, sex) |>
  summarise(months = list(sort(unique(month_num))), .groups = "drop") |>
  (\(data) {
    if (filter_type == "consecutive") {
      data |>
        rowwise() |>
        mutate(
          has_n_windows = {
            m <- months
            if (length(m) < n_windows) FALSE
            else {
              d <- diff(m)
              grp <- cumsum(c(0, d != 1))
              max(rle(grp)$lengths) >= n_windows
            }
          }
        ) |>
        ungroup() |>
        filter(has_n_windows)
    } else {
      data |>
        filter(lengths(months) >= n_windows) |>
        mutate(has_n_windows = TRUE)
    }
  })()

viz_df <- res_df |>
  # Make sure names match the case used in summary_df2
  mutate(chemical_name = str_to_title(chemical_name)) |>
  # Filter by chemical names that passed the 3+ consecutive months test
  filter(chemical_name %in% unique(summary_df2$chemical_name),
         fdr < 0.2) |>
  mutate(
    exposure = case_when(
      str_starts(variable, "bc") ~ "Black carbon",
      str_starts(variable, "pm") ~ "PM2.5",
      TRUE ~ NA_character_
    ),
    exposure_window = case_when(
      str_ends(variable, "1month") ~ "1 month",
      str_ends(variable, "2month") ~ "2 month",
      str_ends(variable, "3month") ~ "3 month",
      str_ends(variable, "4month") ~ "4 month",
      str_ends(variable, "5month") ~ "5 month",
      str_ends(variable, "6month") ~ "6 month",
      str_ends(variable, "7month") ~ "7 month",
      str_ends(variable, "8month") ~ "8 month",
      str_ends(variable, "9month") ~ "9 month",
      TRUE ~ NA_character_
    ),
    super_pathway = recode(super_pathway,
      "Partially Characterized Molecules" = "Other",
      "Energy" = "Other"
    ),
    super_pathway = forcats::fct_relevel(
      super_pathway,
      "Lipid", "Amino Acid", "Carbohydrate", "Cofactors and Vitamins",
      "Peptide", "Nucleotide", "Xenobiotics", "Other"
    ),
    sex = case_match(sex,
      "overall" ~ "Overall",
      "Male" ~ "Male",
      "Female" ~ "Female",
      .default = sex
    ),
    sex = factor(sex, levels = c("Overall", "Male", "Female"))
  )
```

```{r}
p<-ggplot(viz_df, aes(x = exposure_window, y = chemical_name, fill = estimate)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(
  low = scales::muted("darkred"),
  mid = "gray90", 
  high = scales::muted("darkblue"),
  midpoint = 0,
  name = "Estimate"
) +
  labs(x = "Gesational fine particulate matter exposure", y = "Metabolite") +
  ggh4x::facet_nested(super_pathway ~ exposure + sex,
               scales = "free",
               space = "free",
               switch = "both",
               labeller = label_wrap_gen(width = 15))  +
  theme_minimal()  +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5, vjust = 0, color="black"),
        axis.text.y = element_text(size=9.5, color="black"),
        legend.position = "bottom",
        legend.text = element_text(angle = 0, hjust = 1, color="black"),
        legend.title = element_text(vjust = 1),
        legend.key.height = unit(0.3, "cm"),
        panel.grid.major.x = element_blank(), 
        panel.grid.minor.x = element_blank(),
        strip.text.y = element_text(size=0, angle = 45, hjust = 0.5, color="black"),
        strip.text.x = element_text(size=11, color="black"),
        strip.placement = "outside", 
        strip.background = element_blank())
```

```{r}
tiff(
  "~/Documents/air_polln_metabolomics/result/lm_mwas/mwas_metabolite.tiff",
  width = 11, 
  height = 14, 
  units = "in", 
  res = 300, 
  bg = "white"
)
print(p)
dev.off()
```

#detailed metabolism chart for specific pathways - use data from summary_df2
```{r}
#chemical_name includes number of temporal hits
#sub_pathway includes number fo chemicals
#super_pathway includes number of sub_pathways
metab_viz <- summary_df2 |>
  group_by(super_pathway) |>
  mutate(super_pathway = paste0("[[", n_distinct(sub_pathway), "]]: ", super_pathway)) |>
  group_by(super_pathway, sub_pathway) |>
  mutate(sub_pathway = paste0("[[", n_distinct(chemical_name), "]]: ", sub_pathway)) |>
  ungroup() |>
  mutate(chemical_name = paste0("[[", lengths(months), "]]: ", chemical_name)) |>
  select(1:3)
  
```



#export data for python - to produce sankey plot
```{r}
res_df<- read_csv("~/Documents/air_polln_metabolomics/result/lm_mwas/placenta_mwas_oct_2025_anno.csv") |>
  mutate(sub_pathway = str_remove(sub_pathway, " Metabolism$")) |> clean_names()

summary_df <- res_df |>
  filter(fdr < 0.2) |>
  mutate(
    exposure = case_when(
      str_starts(variable, "bc") ~ "Black carbon",
      str_starts(variable, "pm") ~ "PM2.5",
      TRUE ~ NA_character_
    ),
  super_pathway = recode(super_pathway, 
                           "Partially Characterized Molecules" = "Other",
                           "Energy" = "Other"),
  super_pathway = fct_relevel(super_pathway, 
                               "Lipid", 
                               "Amino Acid", 
                               "Carbohydrate", 
                               "Cofactors and Vitamins", 
                               "Peptide", 
                               "Nucleotide", 
                               "Xenobiotics",
                               "Other")
  ) |> select(exposure, super_pathway, sub_pathway, chemical_name) |>
  group_by(exposure, super_pathway, sub_pathway) |>
  summarise(
    n_chem = n_distinct(chemical_name),
    .groups = "drop"
  ) 

write_csv(summary_df, "~/Documents/air_polln_metabolomics/result/lm_mwas/sankey_plt.csv")
```

#upset - overlap plot
```{r}
res_df <- read_csv("~/Documents/air_polln_metabolomics/result/lm_mwas/placenta_mwas_oct_2025_anno.csv") |>
  clean_names() |>
  mutate(sub_pathway = str_remove(sub_pathway, " Metabolism$")) |>
  filter(fdr < 0.2) |>
  mutate(
    exposure = case_when(
      str_starts(variable, "bc_1month") ~ "BC-1m",
      str_starts(variable, "bc_2month") ~ "BC-2m",
      str_starts(variable, "bc_3month") ~ "BC-3m",
      str_starts(variable, "bc_4month") ~ "BC-4m",
      str_starts(variable, "bc_5month") ~ "BC-5m",
      str_starts(variable, "bc_6month") ~ "BC-6m",
      str_starts(variable, "bc_7month") ~ "BC-7m",
      str_starts(variable, "bc_8month") ~ "BC-8m",
      str_starts(variable, "bc_9month") ~ "BC-9m",
      str_starts(variable, "pm_1month") ~ "PM-1m",
      str_starts(variable, "pm_2month") ~ "PM-2m",
      str_starts(variable, "pm_3month") ~ "PM-3m",
      str_starts(variable, "pm_4month") ~ "PM-4m",
      str_starts(variable, "pm_5month") ~ "PM-5m",
      str_starts(variable, "pm_6month") ~ "PM-6m",
      str_starts(variable, "pm_7month") ~ "PM-7m",
      str_starts(variable, "pm_8month") ~ "PM-8m",
      str_starts(variable, "pm_9month") ~ "PM-9m",
      TRUE ~ NA_character_
    ),
    exposure_sex = paste(exposure, sex, sep = "-")
  )

# Step 1: Convert to wide format
wide_df <- res_df |>
  distinct(chemical_name, exposure_sex) |>
  mutate(value = 1) |>
  pivot_wider(names_from = exposure_sex, values_from = value, values_fill = 0) |>
  as.data.frame()

# Custom column order with abbreviated labels
custom_order <- c(
  "PM-1m-overall",
  "PM-2m-overall",
  "PM-3m-overall",
  "PM-4m-overall",
  "PM-5m-overall",
  "PM-6m-overall",
  "PM-7m-overall",
  "PM-8m-overall",
  "PM-9m-overall",
  "BC-2m-overall",
  "BC-3m-overall",
  "BC-4m-overall",
  "BC-5m-overall",
  "BC-6m-overall",
  "BC-7m-overall",
  "BC-8m-overall",
  "PM-1m-Female",
  "PM-2m-Female",
  "PM-3m-Female",
  "PM-5m-Female",
  "PM-6m-Female",
  "PM-8m-Female",
  "BC-2m-Female",
  "BC-3m-Female",
  "BC-4m-Female",
  "BC-5m-Female",
  "BC-6m-Female",
  "PM-1m-Male",
  "PM-2m-Male",
  "PM-4m-Male",
  "PM-7m-Male",
  "BC-2m-Male",
  "BC-6m-Male",
  "BC-7m-Male",
  "BC-8m-Male"
)

# Filter and reorder columns
present_order <- custom_order[custom_order %in% names(wide_df)]
wide_df_ordered <- wide_df[, present_order]

# Color vector for sets - must match length of present_order
set_colors <- ifelse(
  grepl("^PM", present_order),
  "#0072B2",  # Blue for PM2.5
  "#E69F00"   # Orange for Black carbon
)

# Open TIFF with larger dimensions
tiff_file <- "~/Documents/air_polln_metabolomics/result/lm_mwas/upset_plot.tiff"

tiff(filename = tiff_file,
     width = 17,
     height = 16,
     units = "in",
     res = 300)

# Plot with adjusted parameters
upset(wide_df_ordered,
      sets = present_order,
      keep.order = TRUE,
      nsets = length(present_order),
      nintersects = 30,
      set_size.scale_max = 250,
      sets.bar.color = set_colors,
      set_size.show = TRUE,
      text.scale = c(1.5, 1.2, 1.3, 1.2, 1.5),  # c(intersection size, set size, set names, numbers above bars, axis labels)
      point.size = 4,
      line.size = 1.2,
      mainbar.y.label = "No. of overlapping metabolites\nassociated with gestational\nair pollutant exposures",
      sets.x.label = "Metabolites by exposure & sex",
      mainbar.y.max = NULL)

# Close device
if (dev.cur() > 1) dev.off()
```


#summary for article text
```{r}
#total tested
# Example: Table S1 as a data frame
table_s1 <- tibble::tribble(
  ~super_pathway, ~n_sub_pathways_total, ~n_chem_total,
  "Lipid", 55, 433,
  "Amino Acid", 16, 176,
  "Xenobiotics", 13, 103,
  "Cofactors and Vitamins", 10, 35,
  "Carbohydrate", 9, 43,
  "Nucleotide", 9, 76,
  "Peptide", 6, 43,
  "Energy", 2, 12,
  "Partially Characterized Molecules", 1, 10,
  "Other", 0, 140
)

res_df<- read_csv("~/Documents/air_polln_metabolomics/result/lm_mwas/placenta_mwas_oct_2025_anno.csv") |>
  mutate(sub_pathway = str_remove(sub_pathway, " Metabolism$")) |> clean_names()

summary_df<- res_df |>
  filter(fdr < 0.2)  |>
  mutate(
    exposure = case_when(
      str_starts(variable, "bc") ~ "Black carbon",
      str_starts(variable, "pm") ~ "PM2.5",
      TRUE ~ NA_character_
    )) |> 
  #select(c(14,10,11,12,9)) |>
  distinct()  |>
  group_by(exposure, super_pathway, sex) |>
  summarise(
    n_sub_pathway = n_distinct(sub_pathway),
    n_chem = n_distinct(chemical_name),
    .groups = "drop"
  ) |>
  left_join(table_s1, by = "super_pathway") |>
  mutate(
    sub_pathway_ratio = sprintf(
      "%d/%d (%.1f)",
      n_sub_pathway, n_sub_pathways_total,
      (n_sub_pathway / n_sub_pathways_total) * 100
    ),
    n_chem_ratio = sprintf(
      "%d/%d (%.1f)",
      n_chem, n_chem_total,
      (n_chem / n_chem_total) * 100
    )
  ) |>
  select(c(1:3,8,9)) |>
  unite("exposure_sex", exposure, sex, sep = "_") |>   # Combine exposure and sex into one column for pivoting
  pivot_wider(
    names_from = exposure_sex,
    values_from = c(sub_pathway_ratio, n_chem_ratio)
  )

write_csv(summary_df, "~/Documents/air_polln_metabolomics/result/lm_mwas/summary_tbl.csv")
```

#article text - specific pathway detailing
```{r}
x <- res_df |>
  filter(fdr < 0.2) |>
  mutate(
    window = str_extract(variable, "(?<=_).*"),
    exposure = case_when(
      str_starts(variable, "bc") ~ "Black carbon",
      str_starts(variable, "pm") ~ "PM2.5",
      TRUE ~ NA_character_
    ),
  super_pathway = recode(super_pathway, 
                           "Partially Characterized Molecules" = "Other",
                           "Energy" = "Other"),
  super_pathway = fct_relevel(super_pathway, 
                               "Lipid", 
                               "Amino Acid", 
                               "Carbohydrate", 
                               "Cofactors and Vitamins", 
                               "Peptide", 
                               "Nucleotide", 
                               "Xenobiotics",
                               "Other")
  )  |>
  filter(sub_pathway =="Lysine",
         exposure == "Black carbon",
         sex == "male") |>
  distinct(chemical_name) |> 
  pull(chemical_name) |> 
  str_c(collapse = ", ")

chem_list <- str_split(x, ",\\s*") |> unlist()


#Get compound IDs
kegg_list <- df_annotations |> 
  filter(chemical_name %in% chem_list) |> 
  pull(hmdb)
```

#for text description
```{r}
text_summary<- res_df |>
  filter(fdr < 0.2) |>
  mutate(
    exposure = case_when(
      str_starts(variable, "bc") ~ "Black carbon",
      str_starts(variable, "pm") ~ "PM2.5",
      TRUE ~ NA_character_
    ),
  super_pathway = recode(super_pathway, 
                           "Partially Characterized Molecules" = "Other",
                           "Energy" = "Other"),
  super_pathway = fct_relevel(super_pathway, 
                               "Lipid", 
                               "Amino Acid", 
                               "Carbohydrate", 
                               "Cofactors and Vitamins", 
                               "Peptide", 
                               "Nucleotide", 
                               "Xenobiotics",
                               "Other")
  ) |>
  select(c(7:14))
```

